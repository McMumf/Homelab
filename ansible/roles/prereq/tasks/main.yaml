---
- name: Enforce minimum Ansible version
  ansible.builtin.assert:
    that:
      - ansible_version.full is version('2.14', '>=')
    msg: "Minimum ansible-core version required is 2.14"

- name: Set Time Zone
  community.general.timezone:
    name: "{{ system_timezone }}"
  when: (system_timezone is defined) and (system_timezone != "Etc/UTC")

- name: Add /usr/local/bin to sudo secure_path
  lineinfile:
    line: "Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin"
    regexp: "Defaults(\\s)*secure_path(\\s)*="
    state: present
    insertafter: EOF
    path: /etc/sudoers
    validate: "visudo -cf %s"
  when: ansible_distribution in ['CentOS', 'Red Hat Enterprise Linux', 'Debian']

- name: Remove old Kubernetes Repository
  become: true
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"
    state: absent

# Add debian backports repository
- name: Add modified sources.list
  ansible.builtin.copy:
    src: sources.list
    dest: /etc/apt/sources.list
    mode: "0644"
  become: true

- name: Bridge Network Traffic
  include_tasks: bridged-traffic.yaml

- name: Install Common Packages
  become: true
  apt:
    name:
      - vim
      - git
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - python3
      - python3-pip
      - needrestart
      - nut-client
      - cryptsetup
      - software-properties-common
      - ldap-utils
      - iptables
      - ufw
      - parted
      - open-iscsi
      - nfs-common
      - jq
    state: latest
    update_cache: yes

# Upgrade everything to latest (use full upgrade)
- name: Upgrade packages to the latest version
  apt:
    upgrade: full
    update_cache: yes

- name: Free up disk space
  command: apt clean
  become: true

- name: Setup GPU
  include_tasks: i915.yaml
  when: "intel_gpu is defined and intel_gpu"

- name: Configure Network UPS
  include_tasks: nut.yaml
